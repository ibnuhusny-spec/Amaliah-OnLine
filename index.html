<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Amaliah Ramadan</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Amiri:wght@400;700&display=swap');
        body { font-family: 'Nunito', sans-serif; background-color: #f0fdf4; }
        .font-serif { font-family: 'Amiri', serif; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .night-sky {
            background: linear-gradient(to bottom, #0f172a, #312e81);
            position: relative;
            overflow: hidden;
        }
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.7;
            animation: twinkle 2s infinite ease-in-out;
        }
        @keyframes twinkle { 0%, 100% { opacity: 0.7; transform: scale(1); } 50% { opacity: 0.3; transform: scale(0.8); } }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useRef, useMemo } = React;
        
        // --- SISTEM IKON ---
        const LucideIcons = window.lucide ? window.lucide.icons : {};
        const Icon = ({ name, size = 20, className = "", ...props }) => {
            const camelName = name.charAt(0).toLowerCase() + name.slice(1);
            const iconData = LucideIcons[camelName] || LucideIcons[Object.keys(LucideIcons).find(k => k.toLowerCase() === name.toLowerCase())];
            if (!iconData) return <span className={`inline-block bg-slate-200 ${className}`} style={{width:size, height:size}}></span>;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                    {iconData.map((shape, i) => React.createElement(shape[0], { ...shape[1], key: i }))}
                </svg>
            );
        };

        const Icons = {
            Star: (p) => <Icon name="Star" {...p} />,
            Moon: (p) => <Icon name="Moon" {...p} />,
            Sun: (p) => <Icon name="Sun" {...p} />,
            CloudSun: (p) => <Icon name="CloudSun" {...p} />,
            BookOpen: (p) => <Icon name="BookOpen" {...p} />,
            CheckCircle: (p) => <Icon name="CheckCircle" {...p} />,
            Award: (p) => <Icon name="Award" {...p} />,
            ChevronLeft: (p) => <Icon name="ChevronLeft" {...p} />,
            ChevronRight: (p) => <Icon name="ChevronRight" {...p} />,
            User: (p) => <Icon name="User" {...p} />,
            Settings: (p) => <Icon name="Settings" {...p} />,
            Camera: (p) => <Icon name="Camera" {...p} />,
            XIcon: (p) => <Icon name="X" {...p} />,
            Mic: (p) => <Icon name="Mic" {...p} />,
            PenTool: (p) => <Icon name="PenTool" {...p} />,
            StopCircle: (p) => <Icon name="StopCircle" {...p} />,
            Play: (p) => <Icon name="Play" {...p} />,
            CloudUpload: (p) => <Icon name="CloudUpload" {...p} />,
            Lock: (p) => <Icon name="Lock" {...p} />,
            LogOut: (p) => <Icon name="LogOut" {...p} />,
            FileText: (p) => <Icon name="FileText" {...p} />,
            CheckSquare: (p) => <Icon name="CheckSquare" {...p} />,
            Eye: (p) => <Icon name="Eye" {...p} />,
            EyeOff: (p) => <Icon name="EyeOff" {...p} />,
            Save: (p) => <Icon name="Save" {...p} />,
            Wifi: (p) => <Icon name="Wifi" {...p} />,
            WifiOff: (p) => <Icon name="WifiOff" {...p} />,
            Share2: (p) => <Icon name="Share2" {...p} />,
            Loader2: (p) => <Icon name="Loader2" {...p} />,
            Trophy: (p) => <Icon name="Trophy" {...p} />,
            Heart: (p) => <Icon name="Heart" {...p} />,
            Book: (p) => <Icon name="Book" {...p} />,
            Shield: (p) => <Icon name="Shield" {...p} />,
            ArrowRight: (p) => <Icon name="ArrowRight" {...p} />,
            Copy: (p) => <Icon name="Copy" {...p} />,
            Link: (p) => <Icon name="Link" {...p} />,
            Image: (p) => <Icon name="Image" {...p} />,
            List: (p) => <Icon name="List" {...p} />
        };

        // --- DZIKIR PAGI & PETANG (HISNUL MUSLIM) ---
        const DAFTAR_DZIKIR = [
            { 
                judul: "1. Ayat Kursi (Pagi & Petang)", 
                arab: "Ø§Ù„Ù„ÙŽÙ‘Ù‡Ù Ù„ÙŽØ§ Ø¥ÙÙ„ÙŽÙ‡ÙŽ Ø¥ÙÙ„ÙŽÙ‘Ø§ Ù‡ÙÙˆÙŽ Ø§Ù„Ù’Ø­ÙŽÙŠÙÙ‘ Ø§Ù„Ù’Ù‚ÙŽÙŠÙÙ‘ÙˆÙ…Ù Ûš Ù„ÙŽØ§ ØªÙŽØ£Ù’Ø®ÙØ°ÙÙ‡Ù Ø³ÙÙ†ÙŽØ©ÙŒ ÙˆÙŽÙ„ÙŽØ§ Ù†ÙŽÙˆÙ’Ù…ÙŒ Ûš Ù„ÙŽÙ‡Ù Ù…ÙŽØ§ ÙÙÙŠ Ø§Ù„Ø³ÙŽÙ‘Ù…ÙŽØ§ÙˆÙŽØ§ØªÙ ÙˆÙŽÙ…ÙŽØ§ ÙÙÙŠ Ø§Ù„Ù’Ø£ÙŽØ±Ù’Ø¶Ù", 
                latin: "Allahu laa ilaaha illa huwal hayyul qayyum...", 
                arti: "Allah, tidak ada Tuhan selain Dia. Yang Maha Hidup, Yang terus menerus mengurus (makhluk-Nya)... (Dibaca 1x)" 
            },
            { 
                judul: "2. Tiga Qul (Al-Ikhlas, Al-Falaq, An-Nas)", 
                arab: "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„Ù‡Ù Ø§Ù„Ø±ÙŽÙ‘Ø­Ù’Ù…ÙŽÙ†Ù Ø§Ù„Ø±ÙŽÙ‘Ø­ÙÙŠÙ’Ù…Ù . Ù‚ÙÙ„Ù’ Ù‡ÙÙˆÙŽ Ø§Ù„Ù„ÙŽÙ‘Ù‡Ù Ø£ÙŽØ­ÙŽØ¯ÙŒ ...", 
                latin: "Qul huwallahu ahad... (dan seterusnya)", 
                arti: "Masing-masing surah dibaca 3 kali. 'Barangsiapa membacanya 3x di pagi dan petang, maka akan dicukupkan dari segala sesuatu.'" 
            },
            { 
                judul: "3. Sayyidul Istighfar", 
                arab: "Ø§Ù„Ù„ÙŽÙ‘Ù‡ÙÙ…ÙŽÙ‘ Ø£ÙŽÙ†Ù’ØªÙŽ Ø±ÙŽØ¨ÙÙ‘ÙŠ Ù„ÙŽØ§ Ø¥ÙÙ„ÙŽÙ‡ÙŽ Ø¥ÙÙ„ÙŽÙ‘Ø§ Ø£ÙŽÙ†Ù’ØªÙŽ Ø®ÙŽÙ„ÙŽÙ‚Ù’ØªÙŽÙ†ÙÙŠ ÙˆÙŽØ£ÙŽÙ†ÙŽØ§ Ø¹ÙŽØ¨Ù’Ø¯ÙÙƒÙŽ ØŒ ÙˆÙŽØ£ÙŽÙ†ÙŽØ§ Ø¹ÙŽÙ„ÙŽÙ‰ Ø¹ÙŽÙ‡Ù’Ø¯ÙÙƒÙŽ ÙˆÙŽÙˆÙŽØ¹Ù’Ø¯ÙÙƒÙŽ Ù…ÙŽØ§ Ø§Ø³Ù’ØªÙŽØ·ÙŽØ¹Ù’ØªÙ ØŒ Ø£ÙŽØ¹ÙÙˆØ°Ù Ø¨ÙÙƒÙŽ Ù…ÙÙ†Ù’ Ø´ÙŽØ±ÙÙ‘ Ù…ÙŽØ§ ØµÙŽÙ†ÙŽØ¹Ù’ØªÙ ØŒ Ø£ÙŽØ¨ÙÙˆØ¡Ù Ù„ÙŽÙƒÙŽ Ø¨ÙÙ†ÙØ¹Ù’Ù…ÙŽØªÙÙƒÙŽ Ø¹ÙŽÙ„ÙŽÙŠÙŽÙ‘ ÙˆÙŽØ£ÙŽØ¨ÙÙˆØ¡Ù Ø¨ÙØ°ÙŽÙ†Ù’Ø¨ÙÙŠ ÙÙŽØ§ØºÙ’ÙÙØ±Ù’ Ù„ÙÙŠ ÙÙŽØ¥ÙÙ†ÙŽÙ‘Ù‡Ù Ù„ÙŽØ§ ÙŠÙŽØºÙ’ÙÙØ±Ù Ø§Ù„Ø°ÙÙ‘Ù†ÙÙˆØ¨ÙŽ Ø¥ÙÙ„ÙŽÙ‘Ø§ Ø£ÙŽÙ†Ù’ØªÙŽ", 
                latin: "Allahumma anta rabbii laa ilaaha illa anta khalaqtanii wa anaa 'abduka...", 
                arti: "Ya Allah, Engkau adalah Rabbku, tidak ada Tuhan selain Engkau. Engkau telah menciptakanku dan aku adalah hamba-Mu..." 
            },
            { 
                judul: "4. Doa Perlindungan (3x)", 
                arab: "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙŽÙ‘Ù‡Ù Ø§Ù„ÙŽÙ‘Ø°ÙÙŠ Ù„ÙŽØ§ ÙŠÙŽØ¶ÙØ±ÙÙ‘ Ù…ÙŽØ¹ÙŽ Ø§Ø³Ù’Ù…ÙÙ‡Ù Ø´ÙŽÙŠÙ’Ø¡ÙŒ ÙÙÙŠ Ø§Ù„Ù’Ø£ÙŽØ±Ù’Ø¶Ù ÙˆÙŽÙ„ÙŽØ§ ÙÙÙŠ Ø§Ù„Ø³ÙŽÙ‘Ù…ÙŽØ§Ø¡Ù ÙˆÙŽÙ‡ÙÙˆÙŽ Ø§Ù„Ø³ÙŽÙ‘Ù…ÙÙŠØ¹Ù Ø§Ù„Ù’Ø¹ÙŽÙ„ÙÙŠÙ…Ù", 
                latin: "Bismillahilladzi laa yadhurru ma'asmihi syai-un fil ardhi wa laa fis samaa' wa huwas samii'ul 'aliim.", 
                arti: "Dengan nama Allah yang bila disebut, segala sesuatu di bumi dan langit tidak akan berbahaya, Dialah Yang Maha Mendengar lagi Maha Mengetahui." 
            },
            { 
                judul: "5. Doa Ridho (3x)", 
                arab: "Ø±ÙŽØ¶ÙÙŠØªÙ Ø¨ÙØ§Ù„Ù„ÙŽÙ‘Ù‡Ù Ø±ÙŽØ¨Ù‹Ù‘Ø§ØŒ ÙˆÙŽØ¨ÙØ§Ù„Ù’Ø¥ÙØ³Ù’Ù„ÙŽØ§Ù…Ù Ø¯ÙÙŠÙ†Ù‹Ø§ØŒ ÙˆÙŽØ¨ÙÙ…ÙØ­ÙŽÙ…ÙŽÙ‘Ø¯Ù ØµÙŽÙ„ÙŽÙ‘Ù‰ Ø§Ù„Ù„ÙŽÙ‘Ù‡Ù Ø¹ÙŽÙ„ÙŽÙŠÙ’Ù‡Ù ÙˆÙŽØ³ÙŽÙ„ÙŽÙ‘Ù…ÙŽ Ù†ÙŽØ¨ÙÙŠÙ‹Ù‘Ø§", 
                latin: "Radhiitu billahi rabba, wa bil islaami diina, wa bi Muhammadin shallallahu 'alaihi wa sallama nabiyya.", 
                arti: "Aku ridho Allah sebagai Rabb, Islam sebagai agama, dan Muhammad shallallahu 'alaihi wa sallam sebagai Nabi." 
            },
            { 
                judul: "6. Dzikir Pagi", 
                arab: "Ø£ÙŽØµÙ’Ø¨ÙŽØ­Ù’Ù†ÙŽØ§ ÙˆÙŽØ£ÙŽØµÙ’Ø¨ÙŽØ­ÙŽ Ø§Ù„Ù’Ù…ÙÙ„Ù’ÙƒÙ Ù„ÙÙ„ÙŽÙ‘Ù‡ÙØŒ ÙˆÙŽØ§Ù„Ù’Ø­ÙŽÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙŽÙ‘Ù‡Ù...", 
                latin: "Ashbahna wa ashbahal mulku lillahi...", 
                arti: "Kami telah memasuki waktu pagi dan kerajaan hanya milik Allah, segala puji bagi Allah..." 
            },
            { 
                judul: "7. Dzikir Sore", 
                arab: "Ø£ÙŽÙ…Ù’Ø³ÙŽÙŠÙ’Ù†ÙŽØ§ ÙˆÙŽØ£ÙŽÙ…Ù’Ø³ÙŽÙ‰ Ø§Ù„Ù’Ù…ÙÙ„Ù’ÙƒÙ Ù„ÙÙ„ÙŽÙ‘Ù‡ÙØŒ ÙˆÙŽØ§Ù„Ù’Ø­ÙŽÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙŽÙ‘Ù‡Ù...", 
                latin: "Amsaynaa wa amsaynal mulku lillah...", 
                arti: "Kami telah memasuki waktu sore dan kerajaan hanya milik Allah..." 
            },
            { 
                judul: "8. Tasbih & Tahmid (100x)", 
                arab: "Ø³ÙØ¨Ù’Ø­ÙŽØ§Ù†ÙŽ Ø§Ù„Ù„ÙŽÙ‘Ù‡Ù ÙˆÙŽØ¨ÙØ­ÙŽÙ…Ù’Ø¯ÙÙ‡Ù", 
                latin: "Subhanallahi wa bihamdih.", 
                arti: "Maha Suci Allah dan segala puji bagi-Nya. (Dibaca 100x)" 
            }
        ];

        const getGregorianDate = (startDate, dayIndex) => {
            if (!startDate) return "";
            const date = new Date(startDate);
            date.setDate(date.getDate() + (dayIndex - 1));
            return date.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });
        };

        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 500; 
                        const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = (scaleSize < 1) ? MAX_WIDTH : img.width;
                        canvas.height = (scaleSize < 1) ? (img.height * scaleSize) : img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.5)); 
                    }
                }
            });
        };

        const blobToBase64 = (blob) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        };

        // ==========================================
        // APP COMPONENT
        // ==========================================
        function App() {
            const [role, setRole] = useState('home'); 
            const [scriptUrl, setScriptUrl] = useState('');
            const [schoolName, setSchoolName] = useState('Sekolah Dasar Islam Terpadu');
            const [teacherPin, setTeacherPin] = useState('1234');
            const [magicLinkStatus, setMagicLinkStatus] = useState(null); 

            useEffect(() => {
                // 1. Cek Magic Link di URL
                const params = new URLSearchParams(window.location.search);
                const guruScript = params.get('guru');
                const sekolahParam = params.get('school'); // PARAMETER BARU

                if (guruScript) {
                    // MAGIC LINK DETECTED! Apply settings automatically
                    setScriptUrl(guruScript);
                    localStorage.setItem('ramadanScriptUrl', guruScript);
                    
                    if (sekolahParam) {
                        const decodedSchool = decodeURIComponent(sekolahParam);
                        setSchoolName(decodedSchool);
                        
                        // Update profile storage
                        const savedProfile = localStorage.getItem('ramadanProfile') || '{}';
                        const parsed = JSON.parse(savedProfile);
                        parsed.schoolName = decodedSchool;
                        parsed.scriptUrl = guruScript;
                        localStorage.setItem('ramadanProfile', JSON.stringify(parsed));
                    }

                    if (window.location.protocol !== 'file:') {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                    setMagicLinkStatus('success');
                    setTimeout(() => setMagicLinkStatus(null), 6000); 
                } else {
                    // Normal load
                    const globalUrl = localStorage.getItem('ramadanScriptUrl');
                    if(globalUrl) setScriptUrl(globalUrl);

                    const savedProfile = localStorage.getItem('ramadanProfile');
                    if (savedProfile) {
                        const parsed = JSON.parse(savedProfile);
                        if(parsed.schoolName) setSchoolName(parsed.schoolName);
                    }
                }

                const savedPin = localStorage.getItem('teacherPin');
                if (savedPin) setTeacherPin(savedPin);
            }, []);

            const updateGlobalSettings = (newSchoolName, newScriptUrl, newPin) => {
                setSchoolName(newSchoolName);
                setScriptUrl(newScriptUrl);
                setTeacherPin(newPin);
                localStorage.setItem('ramadanScriptUrl', newScriptUrl);
                localStorage.setItem('teacherPin', newPin);
                const savedProfile = localStorage.getItem('ramadanProfile') || '{}';
                const parsed = JSON.parse(savedProfile);
                parsed.schoolName = newSchoolName;
                localStorage.setItem('ramadanProfile', JSON.stringify(parsed));
            };

            const renderContent = () => {
                if (role === 'home') return <HomeView setRole={setRole} schoolName={schoolName} scriptUrl={scriptUrl} teacherPin={teacherPin} onSaveSettings={updateGlobalSettings} magicLinkStatus={magicLinkStatus} />;
                if (role === 'teacher_login') return <TeacherLogin setRole={setRole} scriptUrl={scriptUrl} setScriptUrl={setScriptUrl} currentPin={teacherPin} />;
                if (role === 'teacher') return <TeacherDashboard setRole={setRole} scriptUrl={scriptUrl} schoolName={schoolName} />;
                if (role === 'student') return <StudentApp setRole={setRole} globalScriptUrl={scriptUrl} schoolName={schoolName} />;
                return null;
            };

            return (
                <div className="flex justify-center bg-slate-900 min-h-screen">
                    <div className="w-full max-w-md bg-white shadow-2xl overflow-hidden min-h-screen relative font-sans">
                        {renderContent()}
                        {magicLinkStatus === 'success' && (
                            <div className="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-6 py-4 rounded-xl shadow-2xl z-[100] animate-in fade-in slide-in-from-top-4 flex flex-col items-center text-center">
                                <div className="flex items-center gap-2 mb-1">
                                    <Icons.Wifi size={24} className="animate-pulse"/> 
                                    <span className="font-bold text-lg">Terkoneksi!</span>
                                </div>
                                <p className="text-xs text-green-100">Sekolah: {schoolName}</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- HOME SCREEN ---
        function HomeView({ setRole, schoolName, scriptUrl, teacherPin, onSaveSettings }) {
            const [viewState, setViewState] = useState('home'); 
            const [tempSchoolName, setTempSchoolName] = useState(schoolName);
            const [tempScriptUrl, setTempScriptUrl] = useState(scriptUrl);
            const [tempPin, setTempPin] = useState(teacherPin);
            const [inputPin, setInputPin] = useState('');
            const [showPinChar, setShowPinChar] = useState(false);
            const [logoError, setLogoError] = useState(false);

            useEffect(() => { setTempScriptUrl(scriptUrl); }, [scriptUrl]);
            useEffect(() => { setTempSchoolName(schoolName); }, [schoolName]);

            const handlePinSubmit = () => {
                if (inputPin === teacherPin) {
                    setViewState('admin_panel');
                    setInputPin('');
                } else {
                    alert("PIN Salah!");
                    setInputPin('');
                }
            };

            const handleSave = () => {
                onSaveSettings(tempSchoolName, tempScriptUrl, tempPin);
                alert("Pengaturan tersimpan! Nama Sekolah & Link diperbarui.");
            };

            const goToDashboard = () => {
                if (!tempScriptUrl) {
                    alert("Link Script belum diisi! Isi di menu pengaturan di bawah.");
                    return;
                }
                setRole('teacher');
            };

            return (
                <div className="min-h-screen bg-gradient-to-b from-emerald-600 to-emerald-800 flex flex-col items-center justify-center p-6 text-white relative">
                    <button onClick={() => setViewState('pin_prompt')} className="absolute top-4 right-4 bg-white/10 p-2 rounded-full hover:bg-white/20 transition backdrop-blur-sm z-10"><Icons.Settings size={20} className="text-white" /></button>

                    <div className="bg-white/10 backdrop-blur-md p-6 rounded-3xl w-full border border-white/20 shadow-xl text-center">
                        <div className="w-28 h-28 bg-white rounded-full mx-auto mb-5 flex items-center justify-center shadow-lg overflow-hidden border-4 border-emerald-200">
                            {!logoError ? (
                                <img src="logo.png" alt="Logo" className="w-full h-full object-contain p-1" onError={() => setLogoError(true)} />
                            ) : (
                                <Icons.BookOpen className="text-emerald-600" size={48} />
                            )}
                        </div>
                        <h1 className="text-2xl font-bold font-serif mb-1 leading-tight">Buku Amaliah<br/>Ramadan OnLine</h1>
                        <p className="text-emerald-100 text-sm font-bold mb-4 uppercase tracking-widest">{schoolName}</p>
                        
                        <div className="mb-6 flex justify-center">
                            {scriptUrl ? (
                                <span className="bg-green-500/20 text-green-100 px-3 py-1 rounded-full text-xs flex items-center gap-1 border border-green-400/30"><Icons.Wifi size={12}/> Terhubung ke Kelas</span>
                            ) : (
                                <span className="bg-red-500/20 text-red-100 px-3 py-1 rounded-full text-xs flex items-center gap-1 border border-red-400/30 animate-pulse"><Icons.WifiOff size={12}/> Belum Terhubung</span>
                            )}
                        </div>
                        
                        <div className="space-y-3">
                            <button onClick={() => setRole('student')} className="w-full bg-yellow-400 hover:bg-yellow-300 text-yellow-900 font-bold py-4 rounded-xl flex items-center justify-center gap-3 transition-transform active:scale-95 shadow-lg border-b-4 border-yellow-600"><Icons.User size={24} /> Masuk sebagai Murid</button>
                        </div>
                        <div className="mt-8 pt-4 border-t border-white/10"><p className="text-[10px] text-emerald-200/60">Versi Secure 4.0</p></div>
                    </div>

                    {/* PIN PROMPT */}
                    {viewState === 'pin_prompt' && (
                        <div className="absolute inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white text-slate-800 p-6 rounded-2xl w-full max-w-xs shadow-2xl text-center">
                                <h3 className="font-bold text-lg mb-1">Area Guru</h3>
                                <p className="text-xs text-slate-500 mb-4">Masukkan PIN Akses</p>
                                <div className="relative mb-4">
                                    <input type={showPinChar ? "text" : "password"} value={inputPin} onChange={(e) => setInputPin(e.target.value)} className="w-full p-3 border rounded-xl text-center text-xl font-bold tracking-widest bg-slate-50 focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="â€¢â€¢â€¢â€¢" autoFocus />
                                    <button onClick={() => setShowPinChar(!showPinChar)} className="absolute right-3 top-3.5 text-slate-400">{showPinChar ? <Icons.EyeOff size={16}/> : <Icons.Eye size={16}/>}</button>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setViewState('home')} className="flex-1 py-2 bg-slate-200 text-slate-600 rounded-lg font-bold">Batal</button>
                                    <button onClick={handlePinSubmit} className="flex-1 py-2 bg-emerald-600 text-white rounded-lg font-bold">Masuk</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ADMIN PANEL */}
                    {viewState === 'admin_panel' && (
                        <div className="absolute inset-0 bg-slate-900 z-50 overflow-y-auto">
                            <div className="min-h-full flex flex-col items-center justify-center p-4">
                                <div className="bg-white text-slate-800 p-6 rounded-2xl w-full max-w-sm shadow-2xl relative">
                                    <button onClick={() => setViewState('home')} className="absolute top-4 right-4 bg-slate-100 p-2 rounded-full hover:bg-slate-200"><Icons.XIcon size={20}/></button>
                                    <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><Icons.Shield className="text-emerald-600"/> Panel Guru</h2>

                                    <button onClick={goToDashboard} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white p-4 rounded-xl flex items-center justify-between mb-6 shadow-lg group transition-all">
                                        <div className="text-left"><span className="block font-bold text-lg">Buka Dashboard</span><span className="text-emerald-100 text-xs">Periksa & Nilai Setoran Siswa</span></div>
                                        <Icons.ArrowRight className="group-hover:translate-x-1 transition-transform"/>
                                    </button>

                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-4">
                                        <h3 className="font-bold text-sm text-slate-700 flex items-center gap-2"><Icons.Settings size={16}/> Pengaturan</h3>
                                        <div><label className="text-[10px] font-bold text-slate-500 block mb-1">Nama Sekolah</label><input type="text" value={tempSchoolName} onChange={e => setTempSchoolName(e.target.value)} className="w-full p-2 border rounded-lg text-sm bg-white" /></div>
                                        <div><label className="text-[10px] font-bold text-slate-500 block mb-1">Link Script Google Apps</label><input type="text" value={tempScriptUrl} onChange={e => setTempScriptUrl(e.target.value)} className="w-full p-2 border rounded-lg text-xs font-mono bg-white text-slate-600" /></div>
                                        <div className="pt-2 border-t border-slate-200"><label className="text-[10px] font-bold text-red-500 block mb-1">Ganti PIN Guru</label><input type="text" value={tempPin} onChange={e => setTempPin(e.target.value)} className="w-full p-2 border border-red-200 rounded-lg text-sm bg-red-50 text-center font-bold tracking-widest text-red-800" /></div>
                                        <button onClick={handleSave} className="w-full bg-blue-600 text-white py-2 rounded-lg font-bold text-xs hover:bg-blue-700 flex justify-center items-center gap-2"><Icons.Save size={14}/> Simpan Pengaturan</button>
                                    </div>
                                    <div className="mt-4 text-center"><button onClick={() => setViewState('home')} className="text-xs text-slate-400 hover:text-slate-600 underline">Keluar Panel</button></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- TEACHER DASHBOARD (WITH MAGIC LINK V2 + NO JOURNAL GRADING) ---
        function TeacherDashboard({ setRole, scriptUrl, schoolName }) {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [nilaiInput, setNilaiInput] = useState('');
            const [koreksiInput, setKoreksiInput] = useState('');
            const [saving, setSaving] = useState(false);
            const [errorMsg, setErrorMsg] = useState('');
            const [activeTab, setActiveTab] = useState('jurnal'); 

            useEffect(() => { fetchData(); }, []);

            const fetchData = async () => {
                setLoading(true);
                setErrorMsg('');
                try {
                    const response = await fetch(scriptUrl);
                    if (!response.ok) throw new Error("Gagal mengambil data");
                    const json = await response.json();
                    setData(json);
                } catch (e) {
                    setErrorMsg("Gagal koneksi. Pastikan Link Script benar.");
                } finally {
                    setLoading(false);
                }
            };

            const handleSimpanNilai = async () => {
                if (!selectedStudent) return;
                setSaving(true);
                const payload = JSON.stringify({ 
                    action: 'nilai', 
                    rowIndex: selectedStudent.rowIndex, 
                    nama: selectedStudent.nama, 
                    hari: selectedStudent.hari, 
                    nilaiGuru: nilaiInput, 
                    koreksiGuru: koreksiInput 
                });
                try { await fetch(scriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: payload }); alert("Nilai tersimpan!"); setSelectedStudent(null); fetchData(); } catch (e) { alert("Gagal menyimpan."); } finally { setSaving(false); }
            };

            const openModal = (student) => { setSelectedStudent(student); setNilaiInput(student.nilaiGuru || ''); setKoreksiInput(student.koreksiGuru || ''); };

            // MAGIC LINK V2: INCLUDES SCHOOL NAME
            const copyStudentLink = () => {
                if (!scriptUrl) { alert("Link Script kosong!"); return; }
                const isLocal = window.location.protocol === 'file:';
                if (isLocal) { prompt("Anda offline. Salin Link Script ini manual:", scriptUrl); return; }
                
                const baseUrl = window.location.href.split('?')[0];
                // Encode both URL and School Name
                const magicLink = `${baseUrl}?guru=${encodeURIComponent(scriptUrl)}&school=${encodeURIComponent(schoolName)}`;
                
                if (navigator.clipboard) { navigator.clipboard.writeText(magicLink).then(() => alert("âœ¨ Link Ajaib Tersalin!\n\nLink ini sudah berisi: \n1. Koneksi Database\n2. Nama Sekolah ("+schoolName+")\n\nMurid tinggal klik & pakai!")).catch(() => prompt("Salin manual:", magicLink)); } else { prompt("Salin link:", magicLink); }
            };

            const getFilteredData = () => {
                if (activeTab === 'hafalan') return data.filter(item => item.audio && item.audio.length > 50);
                if (activeTab === 'galeri') return data.filter(item => item.foto && item.foto.length > 50);
                return data.filter(item => (!item.audio || item.audio.length <= 50) && (!item.foto || item.foto.length <= 50)); 
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans pb-20">
                    <div className="bg-white p-4 shadow-sm sticky top-0 z-10">
                        <div className="flex justify-between items-center mb-4"><h1 className="font-bold text-lg text-slate-700 flex items-center gap-2"><Icons.Award className="text-emerald-600"/> Dashboard Guru</h1><button onClick={fetchData} className="p-2 bg-emerald-50 text-emerald-600 rounded-full border border-emerald-100"><Icons.Loader2 size={18} className={loading ? "animate-spin" : ""} /></button></div>
                        <div className="flex bg-slate-100 p-1 rounded-xl">
                            {['jurnal', 'hafalan', 'galeri'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-2 text-xs font-bold rounded-lg capitalize flex items-center justify-center gap-1 transition-all ${activeTab === tab ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}>
                                    {tab === 'jurnal' ? <Icons.List size={14}/> : tab === 'hafalan' ? <Icons.Mic size={14}/> : <Icons.Image size={14}/>} {tab}
                                </button>
                            ))}
                        </div>
                    </div>

                    <div className="p-4 pb-0">
                        <div className="bg-blue-50 border border-blue-200 p-3 rounded-xl flex flex-col gap-3 shadow-sm mb-4">
                            <div className="flex items-start gap-2"><div className="bg-blue-100 p-2 rounded-full text-blue-600"><Icons.Link size={16}/></div><div><span className="font-bold text-sm text-blue-800 block">Link Ajaib (Full Auto)</span><span className="text-xs text-blue-600 leading-tight block">Kirim ini ke murid. Nama sekolah & koneksi otomatis tersetting.</span></div></div>
                            <button onClick={copyStudentLink} className="w-full bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 active:scale-95 shadow hover:bg-blue-700 transition"><Icons.Copy size={14}/> Salin Link Ajaib</button>
                        </div>
                    </div>

                    <div className="p-4 space-y-3 pt-0">
                        {loading ? <div className="text-center py-10 text-slate-400">Memuat data...</div> : 
                        getFilteredData().length === 0 ? <div className="text-center py-10 text-slate-400 bg-white rounded-xl border border-dashed border-slate-300">Belum ada setoran di kategori ini.</div> :
                        getFilteredData().map((item, idx) => (
                        <div key={idx} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                            <div className="flex justify-between items-start mb-2"><div><h3 className="font-bold text-slate-800 flex items-center gap-2">{item.nama} <span className="text-[10px] bg-slate-100 px-1 rounded text-slate-500">#{item.rowIndex}</span></h3><p className="text-xs text-slate-500">Hari ke-{item.hari} â€¢ {item.kelas}</p></div>{activeTab === 'jurnal' && <span className="bg-yellow-100 text-yellow-800 text-[10px] font-bold px-2 py-1 rounded-full border border-yellow-200">{item.poin} Poin (Auto)</span>}</div>
                            {activeTab === 'jurnal' && <div className="bg-slate-50 p-2 rounded-lg text-xs text-slate-600 mb-3 font-mono border border-slate-100">{item.rincian}</div>}
                            {activeTab === 'hafalan' && <div className="mb-3"><div className="bg-blue-50 p-3 rounded-lg border border-blue-100 flex items-center justify-between mb-2"><div className="flex items-center gap-2"><Icons.Play size={14} className="text-blue-600"/><span className="text-xs font-bold text-blue-700">Putar Audio</span></div><audio controls src={item.audio} className="h-8 w-32" /></div><div className="text-[10px] text-slate-500 italic truncate">{item.rincian}</div></div>}
                            {activeTab === 'galeri' && <div className="mb-3"><img src={item.foto} alt="Bukti" className="w-full h-48 rounded-lg border border-slate-200 object-cover mb-2" /><div className="text-[10px] text-slate-500 italic">{item.rincian}</div></div>}
                            
                            {/* HANYA TAMPILKAN TOMBOL NILAI UTK HAFALAN & FOTO */}
                            <div className="border-t pt-2 mt-2 flex justify-between items-center">
                                <div className="text-xs">
                                    {item.nilaiGuru ? <div className="text-green-600 font-bold bg-green-50 px-2 py-1 rounded border border-green-100">Nilai Guru: {item.nilaiGuru}</div> : <span className="text-red-400 italic">Belum dinilai</span>}
                                    {item.koreksiGuru && <span className="text-slate-400 ml-2 italic text-[10px]">"{item.koreksiGuru}"</span>}
                                </div>
                                {activeTab !== 'jurnal' ? 
                                    <button onClick={() => openModal(item)} className="bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 active:scale-95 transition shadow hover:bg-emerald-700"><Icons.PenTool size={12}/> Nilai</button>
                                    :
                                    <span className="text-[10px] text-slate-400 flex items-center gap-1"><Icons.CheckCircle size={10}/> Laporan Jurnal</span>
                                }
                            </div>
                        </div>
                        ))}
                    </div>
                    {selectedStudent && (<div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4"><div className="bg-white w-[90%] max-w-sm rounded-2xl p-6 shadow-2xl relative"><button onClick={() => setSelectedStudent(null)} className="absolute top-4 right-4 bg-slate-100 p-1 rounded-full"><Icons.XIcon size={20} className="text-slate-500"/></button><h3 className="font-bold text-lg mb-1 text-slate-800">Beri Nilai</h3><p className="text-xs text-slate-500 mb-4">{selectedStudent.nama} â€¢ {selectedStudent.rowIndex}</p><div className="space-y-4 mb-6"><div><label className="text-xs font-bold text-slate-500 block mb-1">Nilai Guru</label><input type="text" value={nilaiInput} onChange={(e) => setNilaiInput(e.target.value)} className="w-full p-3 bg-slate-50 border rounded-xl" placeholder="Contoh: 100" /></div><div><label className="text-xs font-bold text-slate-500 block mb-1">Koreksi</label><textarea rows="3" value={koreksiInput} onChange={(e) => setKoreksiInput(e.target.value)} className="w-full p-3 bg-slate-50 border rounded-xl text-sm" /></div></div><button onClick={handleSimpanNilai} disabled={saving} className="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold flex justify-center items-center gap-2">{saving ? <Icons.Loader2 className="animate-spin"/> : <Icons.CheckSquare size={18}/>} Simpan</button></div></div>)}
                    <button onClick={() => setRole('home')} className="fixed bottom-4 right-4 bg-red-500 text-white p-3 rounded-full shadow-lg border border-red-600"><Icons.LogOut size={20}/></button>
                </div>
            );
        }

        // --- TEACHER LOGIN ---
        function TeacherLogin({ setRole, scriptUrl, setScriptUrl, currentPin }) {
            const [pinInput, setPinInput] = useState('');
            const handleLogin = () => { if (pinInput === currentPin) { if (!scriptUrl) return alert("Link Script kosong!"); setRole('teacher'); } else { alert('PIN Salah!'); } };
            return (<div className="min-h-screen bg-slate-100 flex items-center justify-center p-6"><div className="bg-white p-6 rounded-3xl shadow-xl w-full text-center"><h2 className="text-xl font-bold text-slate-800 mb-6">Login Guru</h2><input type="password" value={pinInput} onChange={(e) => setPinInput(e.target.value)} className="w-full p-3 bg-slate-50 border rounded-xl text-center mb-6" placeholder="â€¢â€¢â€¢â€¢" /><div className="flex gap-2"><button onClick={() => setRole('home')} className="flex-1 py-3 bg-slate-200 rounded-xl">Batal</button><button onClick={handleLogin} className="flex-1 py-3 bg-emerald-600 text-white rounded-xl">Masuk</button></div></div></div>);
        }

        // --- STUDENT APP ---
        function StudentApp({ setRole, globalScriptUrl, schoolName }) {
            const [activeDay, setActiveDay] = useState(1);
            const [view, setView] = useState('cover');
            const [userData, setUserData] = useState({});
            const [studentProfile, setStudentProfile] = useState({ name: '', class: '', scriptUrl: globalScriptUrl || '' });
            const [showConfetti, setShowConfetti] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [selectedImage, setSelectedImage] = useState(null);
            const [base64Image, setBase64Image] = useState("");
            const [isRecording, setIsRecording] = useState(false);
            const [audioBlob, setAudioBlob] = useState(null);
            const [audioUrl, setAudioUrl] = useState(null);
            const [namaSurah, setNamaSurah] = useState("");
            const mediaRecorderRef = useRef(null);
            const [raportData, setRaportData] = useState([]);
            const [loadingRaport, setLoadingRaport] = useState(false);
            const [totalGuruScore, setTotalGuruScore] = useState(0); 
            
            const currentDateGregorian = getGregorianDate(studentProfile.startDateRamadan || '2026-02-18', activeDay);
            const triggerConfetti = () => { setShowConfetti(true); setTimeout(() => setShowConfetti(false), 3000); };
            
            useEffect(() => {
                const savedData = localStorage.getItem('ramadanJournalData');
                if (savedData) setUserData(JSON.parse(savedData));
                else { const init = {}; for(let i=1; i<=30; i++) { init[i] = { puasa: false, tarawih: false, validated: false }; } setUserData(init); }
                const effectiveUrl = globalScriptUrl || localStorage.getItem('ramadanScriptUrl') || '';
                const savedProfile = localStorage.getItem('ramadanProfile');
                if (savedProfile) { setStudentProfile({...JSON.parse(savedProfile), scriptUrl: effectiveUrl}); } 
                else if (effectiveUrl) { setStudentProfile(prev => ({...prev, scriptUrl: effectiveUrl})); }
            }, [globalScriptUrl]);

            useEffect(() => { if (Object.keys(userData).length > 0) localStorage.setItem('ramadanJournalData', JSON.stringify(userData)); }, [userData]);
            useEffect(() => { localStorage.setItem('ramadanProfile', JSON.stringify(studentProfile)); }, [studentProfile]);

            // FIX: Ensure prev[day] exists before spreading to allow text input updates
            const updateField = (day, field, value) => { 
                setUserData(prev => {
                    const dayData = prev[day] || {};
                    return { ...prev, [day]: { ...dayData, [field]: value } };
                });
            };
            const toggleCheck = (day, field) => { 
                if (userData[day]?.validated) return; 
                setUserData(prev => {
                    const dayData = prev[day] || {};
                    return { ...prev, [day]: { ...dayData, [field]: !dayData[field] } };
                });
            };
            const togglePuasa = (type) => {
                if (userData[activeDay]?.validated) return;
                setUserData(prev => {
                    const dayData = prev[activeDay] || {};
                    return { ...prev, [activeDay]: { ...dayData, puasaPenuh: type === 'penuh' ? !dayData.puasaPenuh : false, puasaSetengah: type === 'setengah' ? !dayData.puasaSetengah : false } };
                });
            };

            const toggleValidation = (day) => { setUserData(prev => ({ ...prev, [day]: { ...prev[day], validated: !prev[day].validated } })); if (!userData[day].validated) triggerConfetti(); };
            const handleImageUpload = async (e) => { const file = e.target.files[0]; if(file) { if(file.size > 2 * 1024 * 1024) return alert("Ukuran file terlalu besar! Maks 2MB."); setSelectedImage(file.name); try { const b64 = await compressImage(file); setBase64Image(b64); } catch(e){ alert("Gagal memproses gambar."); } } };
            const removeImage = () => { setSelectedImage(null); setBase64Image(""); };
            const startRecording = async () => { try { const stream = await navigator.mediaDevices.getUserMedia({ audio: true }); const options = { mimeType: 'audio/webm;codecs=opus' }; const mediaRecorder = new MediaRecorder(stream, MediaRecorder.isTypeSupported(options.mimeType) ? options : {}); mediaRecorderRef.current = mediaRecorder; const chunks = []; mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); }; mediaRecorder.onstop = () => { const blob = new Blob(chunks, { type: 'audio/webm' }); setAudioBlob(blob); setAudioUrl(URL.createObjectURL(blob)); stream.getTracks().forEach(track => track.stop()); }; mediaRecorder.start(); setIsRecording(true); } catch (e) { alert("Gagal mengakses Mic."); } };
            const stopRecording = () => { if(mediaRecorderRef.current) { mediaRecorderRef.current.stop(); setIsRecording(false); } };
            const deleteRecording = () => { setAudioBlob(null); setAudioUrl(null); };
            
            const calculateDailyScore = (dayData, dayIndex) => { 
                let score = 0; if (!dayData) return 0; 
                if (dayData.puasaPenuh) score += 20; else if (dayData.puasaSetengah) score += 10;
                if (dayData.subuh) score += 10; if (dayData.zuhur) score += 10; if (dayData.ashar) score += 10; if (dayData.maghrib) score += 10; if (dayData.isya) score += 10; 
                if (dayData.tarawih) score += 10; if (dayData.witir) score += 10; if (dayData.tadarus) score += 10; if (dayData.salatMalam) { score += (dayIndex >= 21) ? 20 : 10; } if (dayData.bantuIbu) score += 5; if (dayData.kosakata) score += 5; if (dayData.amalanLainCheck) score += 5; if (dayData.hafalDoa) score += 10; if (dayData.namaPenceramah) score += 5; if (dayData.temaCeramah) score += 10; return score; 
            };
            const calculateTotalLocalScore = () => { let score = 0; Object.entries(userData).forEach(([d, data]) => score += calculateDailyScore(data, parseInt(d))); return score; };
            
            // TOTAL POIN GABUNGAN: (Nilai Auto dari Jurnal) + (Nilai Guru dari Hafalan/Foto)
            const getDisplayScore = () => {
                const localScore = calculateTotalLocalScore();
                // Tambahkan nilai dari server (khusus untuk Hafalan & Foto yang dinilai guru)
                // Kita anggap nilai dari server adalah tambahan untuk Hafalan/Foto, karena poin Jurnal dihitung lokal
                // Namun, untuk menghindari duplikasi jika Guru menilai Jurnal (seharusnya tidak), kita hanya ambil total.
                
                // LOGIKA SIMPLE: Total Poin = (Poin Jurnal Murid) + (Poin Hafalan/Foto Guru)
                // Kita perlu filter raportData yang merupakan audio/foto
                const teacherScore = raportData.reduce((acc, curr) => {
                    const isMedia = (curr.audio && curr.audio.length > 50) || (curr.foto && curr.foto.length > 50);
                    return isMedia ? acc + (parseInt(curr.nilaiGuru) || 0) : acc;
                }, 0);

                return localScore + teacherScore; 
            };

            const sendData = async () => { if(!studentProfile.scriptUrl) return alert("Link Script Guru belum diisi! Hubungi gurumu."); if(view === 'hafalan' && (!audioBlob || !namaSurah)) return alert("Rekam & isi nama surah dulu!"); setIsSubmitting(true); try { const dayData = userData[activeDay] || {}; let payload = {}; if(view === 'hafalan') { const b64Audio = await blobToBase64(audioBlob); payload = { action: 'lapor', nama: studentProfile.name, kelas: studentProfile.class, hari: activeDay, poin: 0, puasa: dayData.puasaPenuh, tarawih: dayData.tarawih, kebaikan: `ðŸŽ¤ Hafalan: ${namaSurah}`, audio: b64Audio, namaSurah: namaSurah }; } else if(view === 'achievements') { payload = { action: 'lapor', nama: studentProfile.name, kelas: studentProfile.class, hari: activeDay, poin: 0, puasa: dayData.puasaPenuh, tarawih: dayData.tarawih, kebaikan: `ðŸ“¸ Foto: ${selectedImage || 'Kegiatan'}`, foto: base64Image, namaFoto: selectedImage }; } else { let rincian = []; if(dayData.salatMalam) rincian.push("âœ… Qiyam"); if(dayData.bantuIbu) rincian.push("âœ… Bantu Ortu"); if(dayData.kosakata) rincian.push("âœ… Kosakata"); if(dayData.amalanLainCheck) rincian.push(`âœ… ${dayData.amalanLain || 'Amalan Lain'}`); if(dayData.tarawih) rincian.push("âœ… Tarawih"); if(dayData.witir) rincian.push("âœ… Witir"); if(dayData.tadarus) rincian.push("âœ… Tadarus"); payload = { action: 'lapor', nama: studentProfile.name, kelas: studentProfile.class, hari: activeDay, poin: calculateDailyScore(dayData, activeDay), puasa: dayData.puasaPenuh, tarawih: dayData.tarawih, kebaikan: rincian.join(", "), foto: "-", audio: "-" }; } await fetch(studentProfile.scriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) }); triggerConfetti(); alert("Terkirim! Guru akan segera menerima datamu."); if(view==='hafalan') deleteRecording(); if(view==='achievements') removeImage(); fetchRaport(); } catch(e) { alert("Gagal kirim. Cek internet atau link guru."); } finally { setIsSubmitting(false); } };
            
            const fetchRaport = async () => { 
                if (!studentProfile.scriptUrl) return; 
                setLoadingRaport(true); 
                try { 
                    const res = await fetch(studentProfile.scriptUrl); 
                    const json = await res.json(); 
                    const myData = json.filter(row => row.nama.toLowerCase() === studentProfile.name.toLowerCase()); 
                    setRaportData(myData); 
                    
                    // Hitung Total Nilai Guru
                    const total = myData.reduce((acc, curr) => acc + (parseInt(curr.nilaiGuru) || 0), 0);
                    setTotalGuruScore(total);
                } catch(e) {} finally { setLoadingRaport(false); } 
            };
            
            useEffect(() => { fetchRaport(); }, [studentProfile.scriptUrl]);
            useEffect(() => { if (view === 'raport') fetchRaport(); }, [view]);

            if (view === 'cover') return (
                <div className="min-h-screen bg-emerald-50 p-6 flex flex-col items-center justify-center text-center font-sans">
                    <div className="bg-white p-6 rounded-3xl shadow-xl w-full border border-emerald-100">
                        <h1 className="text-xl font-bold text-emerald-800 mb-2">Halo, Murid Sholeh!</h1>
                        <input type="text" className="w-full p-3 border rounded-xl mb-3" placeholder="Nama Lengkap" value={studentProfile.name} onChange={e => setStudentProfile({...studentProfile, name: e.target.value})} />
                        <input type="text" className="w-full p-3 border rounded-xl mb-6" placeholder="Kelas" value={studentProfile.class} onChange={e => setStudentProfile({...studentProfile, class: e.target.value})} />
                        <div className="text-xs text-gray-400 mb-4 flex items-center justify-center gap-1">{studentProfile.scriptUrl ? <span className="text-green-600 flex items-center gap-1"><Icons.Wifi size={12}/> Terhubung ke Guru</span> : <span className="text-red-400 flex items-center gap-1"><Icons.WifiOff size={12}/> Belum Terhubung</span>}</div>
                        <button onClick={() => setView('journal')} disabled={!studentProfile.name} className={`w-full py-3 rounded-xl font-bold text-white transition shadow-md ${!studentProfile.name ? 'bg-slate-300' : 'bg-emerald-600 hover:bg-emerald-700'}`}>Buka Bukumu</button>
                        <button onClick={() => setRole('home')} className="mt-4 text-xs text-slate-400">Kembali ke Menu Utama</button>
                    </div>
                </div>
            );
            
            return (
                <div className="min-h-screen bg-emerald-50 pb-24 font-sans">
                    <div className="bg-emerald-600 text-white p-5 rounded-b-3xl shadow-lg sticky top-0 z-10"><div className="flex justify-between items-center mb-2"><div><h1 className="font-bold">{studentProfile.name || 'Murid'}</h1><p className="text-xs opacity-80">{schoolName}</p></div><button onClick={() => setView('cover')} className="bg-white/20 p-2 rounded-full hover:bg-white/30"><Icons.Settings size={18}/></button></div><div className="bg-emerald-800/30 p-2 rounded-xl flex items-center justify-between"><span className="text-xs font-bold flex items-center gap-1"><Icons.Trophy size={14} className="text-yellow-300"/> Total Poin:</span><span className="text-xl font-black text-yellow-300">{getDisplayScore()}</span></div></div>
                    <div className="px-4 -mt-4 relative z-10">
                        <div className="bg-white p-1 rounded-xl shadow-md flex mb-4 text-[10px] font-bold text-center border border-slate-100 overflow-x-auto">{['journal', 'doa', 'hafalan', 'raport', 'achievements'].map(m => (<button key={m} onClick={() => setView(m)} className={`flex-1 py-2 px-1 capitalize rounded-lg transition-colors border ${view===m ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'text-slate-400 border-transparent hover:bg-slate-50'}`}>{m === 'achievements' ? 'Lapor' : m === 'journal' ? 'Jurnal' : m === 'doa' ? 'Dzikir' : m}</button>))}</div>
                        {view === 'journal' && (<div className="space-y-4 animate-in fade-in">
                            <div className="flex items-center justify-between bg-white p-2 rounded-xl shadow-sm border border-slate-200"><button onClick={() => setActiveDay(d => Math.max(1, d - 1))} className="p-2 bg-slate-50 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-100"><Icons.ChevronLeft size={16}/></button><div className="text-center"><div className="font-bold text-slate-800">Hari ke-{activeDay}</div><div className="text-[10px] text-slate-500">{currentDateGregorian}</div></div><button onClick={() => setActiveDay(d => Math.min(30, d + 1))} className="p-2 bg-slate-50 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-100"><Icons.ChevronRight size={16}/></button></div>
                            <div className="night-sky rounded-2xl p-4 text-white shadow-lg mb-4 border border-indigo-900"><div className="star" style={{top: '10%', left: '20%', width: '2px', height: '2px'}}></div><div className="star" style={{top: '40%', left: '80%', width: '3px', height: '3px', animationDelay: '1s'}}></div><div className="flex justify-between items-center relative z-10"><div><h3 className="font-bold text-lg flex items-center gap-2"><Icons.Moon size={18} className="text-yellow-300 fill-yellow-300"/> Salat Malam</h3><p className="text-[10px] text-indigo-200 opacity-80">Qiyamul Lail</p><div className="mt-2 inline-block bg-white/10 border border-white/20 px-2 py-1 rounded text-[10px] font-bold text-yellow-200">Nilai: {activeDay >= 21 ? '20 (Lailatul Qadar)' : '10'} Poin</div></div><button onClick={() => toggleCheck(activeDay, 'salatMalam')} className={`w-12 h-12 rounded-full border-4 flex items-center justify-center transition-all ${userData[activeDay]?.salatMalam ? 'bg-yellow-400 border-yellow-200 text-indigo-900 shadow-[0_0_15px_rgba(250,204,21,0.6)]' : 'bg-transparent border-indigo-400/30 text-transparent hover:bg-white/5'}`}><Icons.CheckSquare size={24} strokeWidth={4} /></button></div></div>
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-4"><h3 className="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-1"><Icons.Sun size={12}/> Puasa Hari Ini</h3><div className="flex gap-2"><button onClick={() => togglePuasa('penuh')} className={`flex-1 py-3 px-2 rounded-xl border-2 flex flex-col items-center justify-center transition ${userData[activeDay]?.puasaPenuh ? 'bg-orange-50 border-orange-500' : 'bg-white border-slate-100'}`}><Icons.Sun size={20} className={userData[activeDay]?.puasaPenuh ? "text-orange-500" : "text-slate-300"} /><span className="text-xs font-bold mt-1 text-slate-700">Penuh (20)</span></button><button onClick={() => togglePuasa('setengah')} className={`flex-1 py-3 px-2 rounded-xl border-2 flex flex-col items-center justify-center transition ${userData[activeDay]?.puasaSetengah ? 'bg-blue-50 border-blue-500' : 'bg-white border-slate-100'}`}><Icons.CloudSun size={20} className={userData[activeDay]?.puasaSetengah ? "text-blue-500" : "text-slate-300"} /><span className="text-xs font-bold mt-1 text-slate-700">Setengah (10)</span></button></div></div>
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200"><h3 className="text-xs font-bold text-slate-400 uppercase mb-3">Shalat Wajib (+10)</h3><div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">{['Subuh','Zuhur','Ashar','Maghrib','Isya'].map(s => (<button key={s} onClick={() => toggleCheck(activeDay, s.toLowerCase())} className={`flex-1 py-2 px-3 rounded-lg text-xs font-bold border transition ${userData[activeDay]?.[s.toLowerCase()] ? 'bg-blue-500 text-white border-blue-500 shadow-md' : 'bg-slate-50 text-slate-400 border-slate-200 hover:border-blue-300'}`}>{s}</button>))}</div></div>
                            <div className="grid grid-cols-3 gap-3">{[{id: 'tarawih', label: 'Tarawih'}, {id: 'witir', label: 'Witir'}, {id: 'tadarus', label: 'Tadarus'}].map(ibadah => (<div key={ibadah.id} onClick={() => toggleCheck(activeDay, ibadah.id)} className={`p-3 rounded-xl border-2 text-center cursor-pointer transition shadow-sm flex flex-col items-center justify-center h-24 ${userData[activeDay]?.[ibadah.id] ? 'bg-indigo-50 border-indigo-500' : 'bg-white border-slate-200 hover:bg-indigo-50'}`}><div className={`mb-1 ${userData[activeDay]?.[ibadah.id] ? 'text-indigo-600' : 'text-slate-300'}`}>{ibadah.id === 'tadarus' ? <Icons.BookOpen size={24}/> : <Icons.Star size={24} className={userData[activeDay]?.[ibadah.id] ? 'fill-indigo-600' : ''}/>}</div><span className="text-[10px] font-bold text-slate-700">{ibadah.label}</span><span className="text-[9px] text-slate-400">+10</span></div>))}</div>
                            <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm space-y-3"><h3 className="text-xs font-bold text-slate-400 uppercase flex items-center gap-1"><Icons.Heart size={12}/> Amalan Harian (+5 Poin)</h3>{[{id: 'bantuIbu', label: 'Membantu Ayah/Ibu'}, {id: 'kosakata', label: 'Menghafal Kosakata'}].map(a => (<div key={a.id} onClick={() => toggleCheck(activeDay, a.id)} className={`flex items-center justify-between p-3 rounded-xl border cursor-pointer transition ${userData[activeDay]?.[a.id] ? 'bg-emerald-50 border-emerald-500' : 'bg-slate-50 border-slate-200 hover:bg-white'}`}><span className="text-sm font-bold text-slate-700">{a.label}</span>{userData[activeDay]?.[a.id] && <Icons.CheckCircle size={18} className="text-emerald-500"/>}</div>))}<div className={`p-3 rounded-xl border transition ${userData[activeDay]?.amalanLainCheck ? 'bg-emerald-50 border-emerald-500' : 'bg-slate-50 border-slate-200'}`}><div className="flex items-center gap-2 mb-2"><input type="checkbox" checked={!!userData[activeDay]?.amalanLainCheck} onChange={() => toggleCheck(activeDay, 'amalanLainCheck')} className="w-5 h-5 accent-emerald-600 rounded cursor-pointer" /><span className="text-sm font-bold text-slate-700">Amalan Lainnya</span></div><input type="text" placeholder="Tulis amalanmu..." className="w-full text-xs p-2 rounded border border-slate-200 bg-white focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 outline-none" value={userData[activeDay]?.amalanLain || ''} onChange={(e) => updateField(activeDay, 'amalanLain', e.target.value)} /></div></div>
                            <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm"><h3 className="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-1"><Icons.Mic size={12}/> Jurnal Ceramah</h3><div className="space-y-3"><div><label className="text-[10px] text-slate-400 font-bold mb-1 block">Nama Penceramah (+5)</label><input type="text" className="w-full text-xs p-3 bg-slate-50 rounded-lg border border-slate-200 focus:border-blue-400 outline-none" placeholder="Contoh: Al-Ustaz Khidir bin Muh. Sunusi" value={userData[activeDay]?.namaPenceramah || ''} onChange={e => updateField(activeDay, 'namaPenceramah', e.target.value)} /></div><div><label className="text-[10px] text-slate-400 font-bold mb-1 block">Tema Ceramah (+10)</label><input type="text" className="w-full text-xs p-3 bg-slate-50 rounded-lg border border-slate-200 focus:border-blue-400 outline-none" placeholder="Isi tema ceramah..." value={userData[activeDay]?.temaCeramah || ''} onChange={e => updateField(activeDay, 'temaCeramah', e.target.value)} /></div></div></div>
                            
                            <div className="bg-blue-50 p-4 rounded-xl border border-blue-200 text-center shadow-sm mb-2">
                                <button onClick={sendData} disabled={isSubmitting} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold flex justify-center items-center gap-2 hover:bg-blue-700 shadow-md">{isSubmitting ? <Icons.Loader2 className="animate-spin"/> : <Icons.CloudUpload/>} Kirim Laporan Jurnal</button>
                                <p className="text-[10px] text-blue-600 mt-2">Poin jurnal dihitung otomatis oleh sistem.</p>
                            </div>
                        </div>)}

                        {view === 'hafalan' && (<div className="bg-white p-6 rounded-2xl text-center shadow-sm animate-in fade-in border border-slate-200"><Icons.Mic size={40} className="mx-auto text-emerald-500 mb-2"/><h2 className="font-bold mb-4">Setor Hafalan Audio</h2><input className="w-full border p-3 rounded-xl mb-4 text-sm bg-slate-50 focus:bg-white focus:border-emerald-500 outline-none" placeholder="Contoh: Surah An-Nas / Hadits Niat" value={namaSurah} onChange={e=>setNamaSurah(e.target.value)}/>{!audioUrl ? <button onClick={isRecording ? stopRecording : startRecording} className={`w-full py-6 rounded-2xl text-white font-bold text-lg flex items-center justify-center gap-2 shadow-lg transition transform active:scale-95 border ${isRecording ? 'bg-red-500 border-red-600 animate-pulse' : 'bg-blue-600 border-blue-700 hover:bg-blue-700'}`}>{isRecording ? <Icons.StopCircle/> : <Icons.Mic/>} {isRecording ? 'Stop Rekam' : 'Mulai Rekam'}</button> : <div className="space-y-3"><div className="bg-slate-100 p-3 rounded-xl flex items-center gap-2 border border-slate-200"><Icons.Play className="text-blue-500" size={20}/> <span className="text-xs font-bold">Rekaman Siap</span></div><div className="flex gap-2"><button onClick={deleteRecording} className="flex-1 py-3 text-red-500 bg-red-50 rounded-xl font-bold text-xs border border-red-200 hover:bg-red-100">Hapus</button><button onClick={() => {const a = new Audio(audioUrl); a.play()}} className="flex-1 py-3 text-blue-500 bg-blue-50 rounded-xl font-bold text-xs border border-blue-200 hover:bg-blue-100">Dengar</button></div><button onClick={sendData} disabled={isSubmitting} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold flex justify-center gap-2 mt-2 shadow-lg hover:bg-green-700 border border-green-700">{isSubmitting ? <Icons.Loader2 className="animate-spin"/> : <Icons.CloudUpload/>} Kirim Hafalan</button></div>}</div>)}
                        
                        {view === 'doa' && (<div className="space-y-3 pb-10">
                            {DAFTAR_DZIKIR.map((doa, i) => (
                                <div key={i} className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                                    <h3 className="font-bold text-sm text-slate-700 mb-2">{doa.judul}</h3>
                                    <p className="text-right font-serif text-lg leading-loose mb-2 text-slate-800">{doa.arab}</p>
                                    <p className="text-xs italic text-slate-500 border-t border-slate-100 pt-2">{doa.latin}</p>
                                    <p className="text-xs text-slate-600 mt-1">{doa.arti}</p>
                                </div>
                            ))}
                        </div>)}
                        
                        {view === 'raport' && (<div className="space-y-3 pb-10"><h2 className="font-bold text-emerald-800 flex items-center gap-2 mb-2"><Icons.FileText size={18}/> Riwayat & Nilai</h2>{loadingRaport ? <div className="text-center text-slate-400 py-4">Mengambil data...</div> : raportData.length === 0 ? <div className="text-center text-slate-400 py-4 bg-white rounded-xl border border-slate-200">Belum ada data nilai.</div> : raportData.map((item, idx) => (<div key={idx} className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-emerald-500 border border-slate-100"><div className="flex justify-between text-xs text-slate-500 mb-1"><span>Hari ke-{item.hari}</span><span>{new Date(item.waktu).toLocaleDateString()}</span></div><div className="font-bold text-slate-800 text-sm mb-1">{item.rincian || 'Laporan Harian'}</div>{(item.nilaiGuru || item.koreksiGuru) ? (<div className="mt-2 bg-yellow-50 p-2 rounded-lg border border-yellow-100">{item.nilaiGuru && <div className="text-sm font-bold text-emerald-600">Nilai: {item.nilaiGuru}</div>}{item.koreksiGuru && <div className="text-xs text-slate-600 italic mt-1">"{item.koreksiGuru}"</div>}</div>) : <div className="mt-1 text-[10px] text-slate-400 italic">Menunggu penilaian guru...</div>}</div>))}</div>)}
                        {view === 'achievements' && (<div className="bg-white p-5 rounded-2xl shadow-sm text-center border border-slate-200"><h2 className="text-lg font-bold mb-1">Lapor Harian</h2><p className="text-xs text-slate-500 mb-4">Kirim poin jurnal & foto bukti kegiatan.</p><div className="mb-4 text-left p-3 bg-slate-50 rounded-xl border border-dashed border-slate-300"><label className="text-xs font-bold text-slate-400 block mb-2">Upload Foto (Opsional)</label>{!selectedImage ? <label className="flex items-center justify-center h-20 cursor-pointer hover:bg-slate-100 transition rounded-lg"><Icons.Camera className="text-slate-300 mr-2"/><span className="text-xs text-slate-400">Ambil Foto (Max 2MB)</span><input type="file" accept="image/*" className="hidden" onChange={handleImageUpload}/></label> : <div className="flex items-center justify-between"><span className="text-xs truncate max-w-[150px]">{selectedImage}</span><button onClick={removeImage} className="text-red-500 p-2 hover:bg-red-50 rounded-full"><Icons.XIcon size={16}/></button></div>}</div><button onClick={sendData} disabled={isSubmitting} className="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl shadow-lg flex justify-center items-center gap-2 hover:bg-emerald-700 border border-emerald-700 transition transform active:scale-95">{isSubmitting ? <Icons.Loader2 className="animate-spin"/> : <Icons.CloudUpload/>} Kirim Laporan</button></div>)}
                    </div>
                    {showConfetti && <div className="fixed inset-0 flex items-center justify-center z-50 text-6xl animate-bounce">ðŸŽ‰</div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
